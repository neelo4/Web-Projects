import { screen } from '@testing-library/react';
import { act } from 'react-dom/test-utils';
import React from 'react';
import { render } from '../../../../test-utils/renderWithProviders';
import EDocsSection from './EDocsSection';
import { AppContext } from '../../../AppContext';
import { GlobalEventsContext } from '@iag-common/mfe-global-events-context';
import { SiteTrackingContext } from '../../../sitetracking/SiteTrackingProvider';

// Define proper interfaces based on your actual types
interface AppState {
  email?: string;
  onboardingAndEdocsResult?: {
    onboardingType?: string;
    eDocsStatus?: boolean;
    eDocsResponseStatus?: boolean;
  };
}

interface Brand {
  id: string;
  name: string;
  // Add other brand properties as needed
}

// Mock contexts
const mockAppContext = {
  appState: {
    email: 'test@example.com',
    onboardingAndEdocsResult: {
      onboardingType: 'GENERAL_ONBOARDING',
      eDocsStatus: false,
      eDocsResponseStatus: false
    }
  } as AppState,
  setAppState: jest.fn((updater: (prevState: AppState) => AppState) => {
    if (typeof updater === 'function') {
      return updater(mockAppContext.appState);
    }
    return updater;
  })
};

const mockGlobalEventsContext = {
  // Add required global events context properties
  dispatch: jest.fn()
};

const mockSiteTrackingContext = {
  dispatch: jest.fn()
};

// Mock components
jest.mock('@iag/policy-correspondence-mfe/OnboardingModuleEDocsConversion', () => ({
  __esModule: true,
  default: () => <div data-testid="mock-edocs-conversion">Mock EDocs Conversion</div>
}));

jest.mock('@iag/chroma-react-ui.spinner', () => ({
  Spinner: () => <div data-testid="mock-spinner">Loading...</div>
}));

// Mock handler functions
const mockSetIsEDocsRequestComplete = jest.fn();
const mockSetIsResponseLoading = jest.fn();
const mockHandleSettingLink = jest.fn();

// Define properly typed default props
const defaultProps = {
  brand: {
    id: 'test-brand',
    name: 'Test Brand'
  } as Brand,
  partyId: 'test-party-id',
  primaryEmail: 'test@example.com',
  eDocsStatus: false,
  handleSettingLink: mockHandleSettingLink,
  setIsEDocsRequestComplete: mockSetIsEDocsRequestComplete,
  setIsResponseLoading: mockSetIsResponseLoading,
};

// Wrapper component to provide all necessary contexts
const TestWrapper: React.FC<{ children: React.ReactNode }> = ({ children }) => (
  <GlobalEventsContext.Provider value={mockGlobalEventsContext}>
    <SiteTrackingContext.Provider value={mockSiteTrackingContext}>
      <AppContext.Provider value={mockAppContext}>
        {children}
      </AppContext.Provider>
    </SiteTrackingContext.Provider>
  </GlobalEventsContext.Provider>
);

describe('EDocsSection', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  afterEach(() => {
    jest.resetAllMocks();
  });

  it('renders without crashing', () => {
    render(
      <TestWrapper>
        <EDocsSection {...defaultProps} />
      </TestWrapper>
    );
    
    expect(screen.getByTestId('mock-edocs-conversion')).toBeInTheDocument();
  });

  it('handles save edocs event correctly', () => {
    render(
      <TestWrapper>
        <EDocsSection {...defaultProps} />
      </TestWrapper>
    );

    act(() => {
      window.dispatchEvent(
        new CustomEvent('policy_corres_mgmt_mfe:save_edocs', {
          detail: { status: true, loadingStatus: false }
        })
      );
    });

    expect(mockSetIsResponseLoading).toHaveBeenCalledWith(false);
    expect(mockSetIsEDocsRequestComplete).toHaveBeenCalledWith(true);
  });

  it('handles save edocs event with loading state', () => {
    render(
      <TestWrapper>
        <EDocsSection {...defaultProps} />
      </TestWrapper>
    );

    act(() => {
      window.dispatchEvent(
        new CustomEvent('policy_corres_mgmt_mfe:save_edocs', {
          detail: { status: true, loadingStatus: true }
        })
      );
    });

    expect(mockSetIsResponseLoading).toHaveBeenCalledWith(true);
    expect(mockSetIsEDocsRequestComplete).toHaveBeenCalledWith(false);
  });

  it('handles setting link click', () => {
    render(
      <TestWrapper>
        <EDocsSection {...defaultProps} />
      </TestWrapper>
    );

    act(() => {
      defaultProps.handleSettingLink(true);
    });

    expect(mockHandleSettingLink).toHaveBeenCalledWith(true);
  });

  it('updates when eDocsStatus changes', () => {
    const propsWithUpdatedStatus = {
      ...defaultProps,
      eDocsStatus: true
    };

    render(
      <TestWrapper>
        <EDocsSection {...propsWithUpdatedStatus} />
      </TestWrapper>
    );

    expect(screen.getByTestId('mock-edocs-conversion')).toBeInTheDocument();
  });

  it('cleans up event listeners on unmount', () => {
    const { unmount } = render(
      <TestWrapper>
        <EDocsSection {...defaultProps} />
      </TestWrapper>
    );

    const removeEventListenerSpy = jest.spyOn(window, 'removeEventListener');
    
    unmount();

    expect(removeEventListenerSpy).toHaveBeenCalledWith(
      'policy_corres_mgmt_mfe:save_edocs',
      expect.any(Function)
    );
  });
});
