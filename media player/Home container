import { BrandDataProps, connectIagBrand } from '@iag-common/iag-brand-context';
import React, { createContext, useContext } from 'react';
import { AppContext } from '../AppContext';
import DashboardLoader from '../components/dashboard/DashboardLoader';
import TechnicalError from '../components/shared/TechnicalError';
import { withDataLoad } from '../hoc/withDataLoad';

import useAuth from '@iag/identity/useAuth';
import StandardLoader from '../components/shared/StandardLoader';
import useDashboardDetails from '../hooks/api/useDashboardDetails';
import { useGetOnboardingAndEdocsDetails } from '../hooks/api/useGetOnboardingAndEdocsDetails';
import useBrowserDetect from '../hooks/useBrowserDetect';
import { HomeDetails } from '../models/HomeDetails';
import { OnboardingAndEdocsStatus } from '../models/OnboardingModule';
import { showDootbOnboardingModule } from '../utils/onboardingModuleUtils';
import Home from './Home';
import OnboardingModule from './OnboardingModulePages/OnboardingModule';

export const HomeDetailsContext = createContext<HomeDetails>(undefined);
export const OnboardingAndEdocsContext = createContext<OnboardingAndEdocsStatus>(undefined);

export const HomeContainer: React.FC<BrandDataProps> = () => {
  const { appState } = useContext(AppContext);
  const { isAuthenticated } = useAuth();
  const { isMobileApp } = useBrowserDetect();

  const isShowDootbOnboardingModule = showDootbOnboardingModule(isMobileApp, isAuthenticated, appState);

  if (!appState?.isOnboardingAndEdocsCallCompleted) {
    return <StandardLoader />;
  }

  if (isShowDootbOnboardingModule && !!HomeDetailsContext) {
    return <OnboardingModule data-testid="onboarding-module" />;
  }

  return <Home />;
};

export default withDataLoad(
  useDashboardDetails,
  HomeDetailsContext,
  () => null,
  () => null,
  {
    Loader: DashboardLoader,
    Error: TechnicalError,
  },
)(
  withDataLoad(
    useGetOnboardingAndEdocsDetails,
    OnboardingAndEdocsContext,
    () => null,
    () => null,
    {
      Loader: DashboardLoader,
      Error: TechnicalError,
    },
  )(connectIagBrand()(HomeContainer)),
);
